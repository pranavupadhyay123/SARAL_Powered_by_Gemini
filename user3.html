<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saral: Smart Alert and Resilient Aid Layer - Citizen App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            900: '#111827',
                            950: '#030712', // Deep OLED Black
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Face API -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .animate-blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #00ff00;
            animation: scan 2s linear infinite;
            box-shadow: 0 0 10px #00ff00;
        }

        @keyframes scan {
            0% {
                top: 0%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        /* AI Gradient Text */
        .text-gradient-ai {
            background: linear-gradient(to right, #4ade80, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Smooth Theme Transition */
        body,
        div,
        nav,
        button,
        input,
        select,
        textarea {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        /* TOAST NOTIFICATION */
        #toast-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background: rgba(16, 185, 129, 0.95);
            /* Emerald */
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            animation: slideUpFade 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toast i {
            font-size: 1.1rem;
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-950 text-gray-800 dark:text-gray-200 font-sans pb-20">

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- NAVBAR -->
    <nav class="bg-gradient-to-r from-gray-900 via-blue-900 to-gray-900 text-white p-3 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-lg backdrop-blur-sm border border-white/20">
                    <i class="fas fa-shield-virus text-2xl text-yellow-400"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-wide md:hidden flex items-center gap-2">
                        <span data-i18n="title">SARAL</span> <span
                            class="text-[10px] bg-blue-600 px-1.5 py-0.5 rounded text-white font-normal">AI</span>
                    </h1>
                    <h1 class="text-xl font-bold tracking-wide hidden md:block" data-i18n="full_title">Saral: AI
                        Disaster Response</h1>
                </div>
            </div>
            <div class="flex items-center gap-3 md:gap-4">
                <div class="hidden md:block text-right">
                    <p class="text-[10px] text-gray-400 font-mono">ID</p>
                    <p class="text-xs font-mono text-blue-300" id="user-id-display">...</p>
                </div>

                <!-- Language Selector -->
                <select onchange="changeLanguage(this.value)"
                    class="bg-white/10 text-white border-none text-xs rounded p-1 focus:ring-0 cursor-pointer hover:bg-white/20 transition">
                    <option value="en">üá∫üá∏ EN</option>
                    <option value="hi">üáÆüá≥ HI</option>
                    <option value="es">üá™üá∏ ES</option>
                    <option value="ko">üá∞üá∑ KO</option>
                    <option value="ja">üáØüáµ JA</option>
                    <option value="zh">üá®üá≥ ZH</option>
                </select>

                <!-- API Key Settings -->
                <button onclick="promptApiKey()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-cog text-xl"></i>
                </button>
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()"
                    class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition focus:outline-none">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- STATUS BANNER -->
    <div
        class="bg-emerald-600 dark:bg-emerald-800 text-white p-2 text-center font-bold text-xs shadow-md tracking-wider">
        <i class="fas fa-satellite"></i> <span data-i18n="status">SYSTEM ONLINE | GEMINI 3.0 CONNECTED</span>
    </div>

    <div class="p-4 max-w-md lg:max-w-7xl mx-auto flex flex-col gap-6 mt-2">

        <!-- CORE ACTIONS ROW -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <!-- LEFT: AI HAZARD EYE (CORE) -->
            <div
                class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 overflow-hidden relative p-6 flex flex-col items-center text-center">
                <div class="mb-4 bg-orange-100 dark:bg-orange-900/30 p-4 rounded-full text-orange-600">
                    <i class="fas fa-eye text-3xl"></i>
                </div>
                <h3 class="font-bold text-xl mb-1">Report Hazard</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Use AI to analyze structural damage or fire
                    risks instantly.</p>
                <button onclick="openHazardModal()"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-camera"></i> LAUNCH AI EYE
                </button>
            </div>

            <!-- RIGHT: SOS (CORE) -->
            <div
                class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 overflow-hidden relative p-6 flex flex-col items-center text-center">
                <div class="mb-4 bg-red-100 dark:bg-red-900/30 p-4 rounded-full text-red-600 animate-pulse">
                    <i class="fas fa-broadcast-tower text-3xl"></i>
                </div>
                <h3 class="font-bold text-xl mb-1">Emergency SOS</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Broadcast high-priority distress signal to all
                    nearby units.</p>
                <button onclick="sendSOS()"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-exclamation-circle"></i> SEND SOS
                </button>
            </div>

        </div>

        <!-- CENTER: MAP -->
        <div
            class="bg-white dark:bg-gray-900 p-1 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 h-[450px] flex flex-col relative">
            <div
                class="absolute top-4 left-4 z-[400] bg-white/90 dark:bg-black/80 backdrop-blur px-3 py-1.5 rounded-lg shadow border border-gray-200 dark:border-gray-700 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-xs font-bold text-gray-700 dark:text-gray-300" data-i18n="live_tracking">Live
                    Tracking</span>
            </div>
            <div id="map" class="rounded-lg bg-gray-100 dark:bg-gray-800 flex-grow h-full w-full z-0"></div>
        </div>

        <!-- EXPLANATORY FOOTER -->
        <div class="text-center mt-2 px-6">
            <p class="text-[10px] text-gray-500 dark:text-gray-500 mb-1">
                SARAL uses Gemini as a centralized incident intelligence engine that classifies, prioritizes, and guides
                response across all modules.
            </p>
            <p class="text-[10px] text-gray-400 uppercase tracking-widest opacity-70">
                <i class="fas fa-layer-group mr-1"></i> Advanced modules activate after incident classification.
            </p>
        </div>

    </div>

    <!-- === MODALS === -->

    <!-- AI HAZARD EYE MODAL -->
    <div id="hazard-modal"
        class="hidden fixed inset-0 z-[2000] bg-black/90 flex flex-col items-center justify-center p-4">
        <div
            class="w-full max-w-lg bg-gray-900 rounded-2xl overflow-hidden border border-orange-500 shadow-2xl relative">
            <div class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700">
                <h2 class="text-orange-500 font-bold flex items-center gap-2">
                    <i class="fas fa-eye animate-pulse"></i> <span data-i18n="hazard_modal_title">‚ú® AI HAZARD EYE</span>
                </h2>
                <button onclick="closeHazardModal()" class="text-gray-400 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="relative w-full aspect-video bg-black group">
                <video id="hazard-video" class="w-full h-full object-cover opacity-80" autoplay muted
                    playsinline></video>
                <canvas id="hazard-canvas" class="hidden"></canvas>

                <div class="scan-line hidden" id="hazard-scan-line"></div>
                <div id="hazard-analysis-box"
                    class="hidden absolute bottom-4 left-4 right-4 bg-black/80 border-l-4 border-orange-500 p-3 rounded backdrop-blur-sm">
                    <div class="text-orange-400 text-xs font-bold mb-1 uppercase tracking-wider flex justify-between">
                        <span>Gemini 3.0 Analysis</span>
                        <i class="fas fa-robot"></i>
                    </div>
                    <p class="text-white text-sm leading-tight mb-2" id="hazard-text">Analyzing...</p>
                    <div id="hazard-badge-container" class="hidden flex items-center">
                        <span id="hazard-severity-badge"
                            class="px-2 py-0.5 rounded text-[10px] font-bold text-white bg-gray-600 border border-white/20"></span>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-800 flex gap-3">
                <button onclick="analyzeHazard()" id="btn-hazard-scan"
                    class="flex-1 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white py-3 rounded-lg font-bold text-sm shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-magic"></i> <span data-i18n="hazard_btn_scan">‚ú® AI ANALYZE</span>
                </button>
                <button onclick="sendHazardReport()" id="btn-hazard-send"
                    class="hidden flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold text-sm shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-paper-plane"></i> <span data-i18n="hazard_btn_send">REPORT TO HQ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- AI HEALTH ASSISTANT MODAL (Accessible via code/hidden logic if needed, but keeping it clean) -->
    <!-- Note: Keeping structure for future dynamic enabling as per footer note -->
    <div id="health-modal"
        class="hidden fixed inset-0 z-[2000] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-gray-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-gradient-to-r from-red-600 to-pink-600 p-4 text-white flex justify-between items-center">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-user-md"></i> <span
                        data-i18n="medic_modal_title">‚ú® AI Medic Assistant</span></h2>
                <button onclick="closeHealthModal()" class="text-white/80 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>

            <div class="px-3 py-2 bg-blue-50/50 dark:bg-blue-900/10 border-b border-blue-100 dark:border-blue-800/50">
                <p class="text-[10px] text-gray-500 dark:text-gray-400 leading-tight">
                    Gemini powers incident intelligence & prioritization. Other modules assist users locally.
                </p>
            </div>

            <div class="flex border-b border-gray-200 dark:border-gray-700">
                <button onclick="switchHealthTab('voice')" id="tab-voice"
                    class="flex-1 py-3 text-xs font-bold text-red-600 border-b-2 border-red-600 bg-red-50 dark:bg-red-900/20"><i
                        class="fas fa-microphone mr-1"></i> <span data-i18n="medic_tab_voice">VOICE
                        TRIAGE</span></button>
                <button onclick="switchHealthTab('cam')" id="tab-cam"
                    class="flex-1 py-3 text-xs font-bold text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800"><i
                        class="fas fa-camera mr-1"></i> <span data-i18n="medic_tab_cam">VISUAL SCAN</span></button>
            </div>

            <!-- Voice Tab -->
            <div id="content-voice" class="p-6 flex flex-col items-center text-center space-y-6">
                <div
                    class="w-24 h-24 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center relative">
                    <i class="fas fa-microphone text-3xl text-red-500 dark:text-red-400" id="mic-icon"></i>
                    <div class="absolute inset-0 border-4 border-red-200 dark:border-red-800 rounded-full animate-ping hidden"
                        id="mic-ping"></div>
                </div>
                <div class="w-full bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 min-h-[60px] text-sm text-gray-700 dark:text-gray-300 italic"
                    id="voice-transcript">Tap mic to start...</div>
                <button onclick="toggleVoiceHealth()" id="btn-voice-toggle"
                    class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                    <i class="fas fa-microphone-alt"></i> <span data-i18n="medic_btn_listen">START LISTENING</span>
                </button>
            </div>

            <!-- Cam Tab -->
            <div id="content-cam" class="hidden p-0 relative bg-black h-[300px]">
                <video id="health-video" class="w-full h-full object-cover" autoplay playsinline></video>
                <canvas id="health-canvas" class="hidden"></canvas>
                <button onclick="analyzeHealthCam()"
                    class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white text-red-600 px-6 py-2 rounded-full font-bold text-sm shadow-xl flex items-center gap-2">
                    <i class="fas fa-magic"></i> <span data-i18n="medic_btn_analyze">‚ú® AI ANALYZE</span>
                </button>
            </div>

            <div id="health-result" class="hidden bg-gray-900 text-white p-4 animate-slide-up border-t border-gray-700">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] uppercase tracking-wider text-blue-400">Gemini 3.0 Diagnosis</span>
                    <span id="triage-badge"
                        class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-600 text-white">ANALYZING</span>
                </div>
                <div id="health-diagnosis" class="text-sm font-medium mb-3 text-gray-200">Processing...</div>
                <button onclick="submitHealthReport()"
                    class="w-full bg-white text-gray-900 py-2 rounded font-bold text-sm hover:bg-gray-200"
                    data-i18n="medic_btn_send">SEND REPORT TO HQ</button>
            </div>
        </div>
    </div>

    <!-- SURVIVAL GUIDE MODAL (NEW) -->
    <div id="survival-modal"
        class="hidden fixed inset-0 z-[2200] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-gray-900 w-full max-w-lg rounded-2xl shadow-2xl p-6 relative border border-gray-200 dark:border-gray-700">
            <button onclick="document.getElementById('survival-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i
                    class="fas fa-times text-xl"></i></button>

            <h2 class="text-2xl font-bold mb-1 flex items-center gap-2 text-gray-800 dark:text-white">
                <i class="fas fa-robot text-yellow-500"></i> <span data-i18n="survival_modal_title">AI Survival
                    Guide</span>
            </h2>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Powered by Gemini 3.0 (Preview)</p>

            <div
                class="px-3 py-2 bg-blue-50/50 dark:bg-blue-900/10 border-b border-blue-100 dark:border-blue-800/50 mb-4 rounded">
                <p class="text-[10px] text-gray-500 dark:text-gray-400 leading-tight">
                    Gemini powers incident intelligence & prioritization. Other modules assist users locally.
                </p>
            </div>

            <div class="flex gap-2 mb-4">
                <div class="flex-grow relative">
                    <input type="text" id="ai-prompt" placeholder="e.g., How to stop bleeding? or Flood safety"
                        class="w-full p-3 pr-10 border border-gray-300 dark:border-gray-700 rounded-lg text-sm bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 outline-none">
                    <button onclick="toggleSurvivalVoice()"
                        class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                <button onclick="askSurvivalAI()"
                    class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-2 mb-2 flex justify-end">
                <button onclick="speakResponse()"
                    class="text-xs font-bold text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 flex items-center gap-1">
                    <i class="fas fa-volume-up"></i> <span data-i18n="survival_read_aloud">Read Aloud</span>
                </button>
            </div>

            <div id="ai-response-area"
                class="h-64 overflow-y-auto bg-gray-50 dark:bg-gray-800 rounded-lg p-4 text-sm text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 custom-scroll">
                <div class="text-center text-gray-400 dark:text-gray-500 mt-10">
                    <i class="fas fa-sparkles mb-2"></i>
                    <p>Ask anything about disaster safety.</p>
                </div>
            </div>
        </div>
    </div>


    <!-- DAMAGE REPORT MODAL -->
    <div id="damage-modal"
        class="hidden fixed inset-0 z-[1500] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-xl p-6 shadow-2xl border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-orange-700 dark:text-orange-400"><i
                    class="fas fa-exclamation-triangle"></i> <span data-i18n="damage_modal_title">Report Damage</span>
            </h2>
            <form onsubmit="submitDamageReport(event)" class="space-y-3">
                <select id="damage-type"
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm font-bold text-gray-800 dark:text-gray-200">
                    <option value="Road Blocked">üöß Road Blocked</option>
                    <option value="Building Collapse">üèö Building Collapse</option>
                    <option value="Power Failure">‚ö° Power Failure</option>
                    <option value="Flooding">üåä Flooding</option>
                </select>
                <textarea id="damage-desc" placeholder="Describe the situation..."
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm h-20 text-gray-800 dark:text-gray-200"></textarea>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('damage-modal').classList.add('hidden')"
                        class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 py-2 rounded font-bold text-sm"
                        data-i18n="damage_btn_cancel">Cancel</button>
                    <button type="submit" class="flex-1 bg-orange-600 text-white py-2 rounded font-bold text-sm shadow"
                        data-i18n="damage_btn_submit">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LOST & FOUND MODAL -->
    <div id="lost-modal"
        class="hidden fixed inset-0 z-[1500] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-xl p-6 shadow-2xl border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-purple-700 dark:text-purple-400"><i class="fas fa-search"></i> <span
                        data-i18n="missing_modal_title">Lost & Found</span></h2>
                <div class="flex bg-gray-100 dark:bg-gray-800 rounded p-1">
                    <button onclick="toggleLostTab('person')" id="tab-person"
                        class="px-3 py-1 rounded bg-purple-600 text-white text-xs font-bold transition"
                        data-i18n="missing_tab_person">Person</button>
                    <button onclick="toggleLostTab('item')" id="tab-item"
                        class="px-3 py-1 rounded text-gray-500 dark:text-gray-400 text-xs font-bold transition hover:bg-gray-200 dark:hover:bg-gray-700"
                        data-i18n="missing_tab_item">Item</button>
                </div>
            </div>
            <!-- Missing Person Form -->
            <form id="form-person" onsubmit="submitLostReport(event, 'person')" class="space-y-3">
                <input type="text" id="p-name" placeholder="Name of Person"
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200"
                    required>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="p-age" placeholder="Age"
                        class="p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200"
                        required>
                    <select id="p-gender"
                        class="p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200">
                        <option>Male</option>
                        <option>Female</option>
                        <option>Child</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Physical
                        Description</label>
                    <textarea id="p-desc" placeholder="Height, clothes, scars, etc."
                        class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm h-16 text-gray-800 dark:text-gray-200"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Upload Recent
                        Photo</label>
                    <input type="file" id="p-image" accept="image/*"
                        class="w-full text-xs text-gray-500 dark:text-gray-400 file:mr-2 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-purple-50 dark:file:bg-purple-900/30 file:text-purple-700 dark:file:text-purple-300 hover:file:bg-purple-100 dark:hover:file:bg-purple-900/50">
                </div>
                <input type="tel" id="p-contact" placeholder="Your Contact Number"
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200"
                    required>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('lost-modal').classList.add('hidden')"
                        class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 py-2 rounded font-bold text-sm"
                        data-i18n="damage_btn_cancel">Cancel</button>
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-2 rounded font-bold text-sm shadow"
                        data-i18n="missing_btn_report">Report Missing</button>
                </div>
            </form>
            <!-- Lost Item Form -->
            <form id="form-item" onsubmit="submitLostReport(event, 'item')" class="hidden space-y-3">
                <input type="text" id="i-desc" placeholder="Item Description"
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200"
                    required>
                <input type="tel" id="i-contact" placeholder="Your Contact Number"
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200"
                    required>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('lost-modal').classList.add('hidden')"
                        class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 py-2 rounded font-bold text-sm"
                        data-i18n="damage_btn_cancel">Cancel</button>
                    <button type="submit" class="flex-1 bg-gray-700 text-white py-2 rounded font-bold text-sm shadow"
                        data-i18n="missing_btn_report">Report Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- VOLUNTEER MODAL -->
    <div id="volunteer-modal"
        class="hidden fixed inset-0 z-[1500] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-xl p-6 shadow-2xl border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-teal-700 dark:text-teal-400"><i class="fas fa-hands-helping"></i>
                    <span data-i18n="volunteer_modal_title">Community</span></h2>
                <div class="flex bg-gray-100 dark:bg-gray-800 rounded p-1">
                    <button onclick="toggleVolTab('request')" id="tab-request"
                        class="px-3 py-1 rounded bg-teal-600 text-white text-xs font-bold transition"
                        data-i18n="volunteer_tab_req">Request</button>
                    <button onclick="toggleVolTab('join')" id="tab-join"
                        class="px-3 py-1 rounded text-gray-500 dark:text-gray-400 text-xs font-bold transition hover:bg-gray-200 dark:hover:bg-gray-700"
                        data-i18n="volunteer_tab_join">Join</button>
                </div>
            </div>
            <!-- Request -->
            <form id="form-request" onsubmit="submitVolunteer(event, 'request')" class="space-y-3">
                <select id="req-type"
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200">
                    <option value="Food/Water">üçû Need Food / Water</option>
                    <option value="Shelter">‚õ∫ Need Shelter</option>
                    <option value="Medical">üíä Need Medical Supplies</option>
                </select>
                <input type="number" id="req-qty" placeholder="Quantity (e.g. 5)"
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200"
                    required>
                <button type="submit" class="w-full bg-teal-600 text-white py-2 rounded font-bold text-sm shadow"
                    data-i18n="volunteer_btn_post" title="Advanced Module">Post Request</button>
            </form>
            <!-- Join -->
            <form id="form-join" onsubmit="submitVolunteer(event, 'join')" class="hidden space-y-3">
                <input type="text" id="vol-name" placeholder="Name"
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200"
                    required>
                <select id="vol-skill"
                    class="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 text-sm text-gray-800 dark:text-gray-200">
                    <option value="General">General Help</option>
                    <option value="Medic">Medical</option>
                    <option value="Driver">Driver</option>
                </select>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm shadow"
                    data-i18n="volunteer_btn_register" title="Advanced Module">Register</button>
            </form>
            <button onclick="document.getElementById('volunteer-modal').classList.add('hidden')"
                class="mt-4 text-xs text-gray-500 dark:text-gray-400 underline w-full" data-i18n="close">Close</button>
        </div>
    </div>

    <!-- CHECKLIST MODAL -->
    <div id="checklist-modal"
        class="hidden fixed inset-0 z-[1500] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-xl p-6 shadow-2xl border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white" data-i18n="checklist_modal_title">üéí
                Preparedness Checklist</h2>
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 accent-blue-600"> <span
                        class="text-sm text-gray-700 dark:text-gray-300" data-i18n="check_gobag">Pack Go-Bag</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 accent-blue-600"> <span
                        class="text-sm text-gray-700 dark:text-gray-300" data-i18n="check_contacts">Emergency
                        Contacts</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 accent-blue-600"> <span
                        class="text-sm text-gray-700 dark:text-gray-300" data-i18n="check_maps">Download Offline
                        Maps</span>
                </label>
            </div>
            <button onclick="document.getElementById('checklist-modal').classList.add('hidden')"
                class="w-full bg-gray-800 dark:bg-gray-700 text-white py-3 rounded-lg font-bold"
                data-i18n="close">Close</button>
        </div>
    </div>

    <!-- SCANNER MODAL -->
    <div id="scanner-modal"
        class="hidden fixed inset-0 z-[1600] bg-black/80 flex items-center justify-center p-4 backdrop-blur-md">
        <div
            class="bg-gray-900 w-full max-w-lg rounded-xl p-4 shadow-2xl border border-pink-500 relative flex flex-col items-center">
            <button onclick="closeScannerModal()" class="absolute top-2 right-2 text-gray-400 hover:text-white"><i
                    class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold text-pink-500 mb-2 flex items-center gap-2">
                <i class="fas fa-expand"></i> <span data-i18n="scanner_modal_title">Gemini 3.0 Person Finder</span>
            </h2>

            <!-- Description Input -->
            <div class="w-full mb-3">
                <input type="text" id="scan-target" placeholder="Describe person (e.g., Boy in red shirt, age 10)"
                    class="w-full bg-gray-800 text-white border border-gray-600 rounded p-2 text-sm focus:border-pink-500 outline-none">
            </div>

            <div class="relative w-full aspect-video bg-black rounded overflow-hidden border border-gray-700">
                <video id="scanner-video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                <canvas id="scanner-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                <!-- Hidden Canvas for Snapshot -->
                <canvas id="snapshot-canvas" class="hidden"></canvas>

                <div id="scan-status"
                    class="absolute bottom-2 left-2 px-2 py-1 bg-black/60 text-white text-[10px] rounded font-mono">
                    Initializing...</div>
            </div>

            <div class="mt-4 flex gap-3 w-full">
                <button onclick="toggleScanner(true)" id="btn-start-scan"
                    class="flex-1 bg-pink-600 hover:bg-pink-500 text-white py-2 rounded font-bold text-sm"
                    data-i18n="scanner_btn_start">Start AI Scan</button>
                <button onclick="toggleScanner(false)" id="btn-stop-scan"
                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-300 py-2 rounded font-bold text-sm hidden"
                    data-i18n="scanner_btn_stop">Stop</button>
                <button onclick="flipCamera()" id="btn-flip-cam"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded font-bold text-sm"><i
                        class="fas fa-sync-alt"></i></button>
            </div>
            <div id="scan-result"
                class="hidden mt-3 w-full bg-green-900/30 border border-green-500 p-3 rounded flex flex-col gap-2 animate-fade-in">
                <div class="flex items-center justify-between">
                    <div class="text-green-400 font-bold text-sm"><i class="fas fa-check-circle"></i> MATCH FOUND!</div>
                    <button onclick="notifyMatch()"
                        class="bg-green-600 text-white px-2 py-1 rounded text-xs font-bold">NOTIFY HQ</button>
                </div>
                <div id="match-desc" class="text-white text-xs leading-tight">AI Description...</div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // --- API KEY CONFIGURATION ---
        let GEMINI_API_KEY = localStorage.getItem('saral_gemini_key') || "AIzaSyAJa6WXkcKA1fyVqaOV5KG5PdtQvB3r0Es";

        function promptApiKey() {
            const key = prompt("Enter Google Gemini API Key:", GEMINI_API_KEY);
            if (key !== null) {
                GEMINI_API_KEY = key;
                localStorage.setItem('saral_gemini_key', key);
                alert("API Key Saved!");
            }
        }

        // --- TRANSLATIONS (Expanded for Korean, Japanese, Chinese) ---
        const translations = {
            en: { title: "SARAL", full_title: "Saral: AI Disaster Response", status: "SYSTEM ONLINE | GEMINI 3.0 CONNECTED", hazard_eye: "‚ú® Hazard Eye", hazard_modal_title: "‚ú® AI HAZARD EYE", hazard_btn_scan: "‚ú® AI ANALYZE", hazard_btn_send: "REPORT TO HQ", live_tracking: "Live Tracking", sos_title: "EMERGENCY SOS", sos_sub: "Broadcast Location & ID", report_damage: "Report Damage", damage_sub: "Infra / Roads", report_missing: "Report Missing", missing_sub: "Broadcast Alert", face_scanner: "Face Scanner", scanner_sub: "Find People (AI)", volunteer: "Volunteer", volunteer_sub: "Request / Join", damage_modal_title: "Report Damage", damage_btn_cancel: "Cancel", damage_btn_submit: "Submit", missing_modal_title: "Lost & Found", missing_tab_person: "Person", missing_tab_item: "Item", missing_btn_report: "Report Missing", scanner_modal_title: "Gemini 3.0 Person Finder", scanner_btn_start: "Start AI Scan", scanner_btn_stop: "Stop", volunteer_modal_title: "Community", volunteer_tab_req: "Request", volunteer_tab_join: "Join", volunteer_btn_post: "Post Request", volunteer_btn_register: "Register", checklist_modal_title: "üéí Preparedness Checklist", check_gobag: "Pack Go-Bag", check_contacts: "Emergency Contacts", check_maps: "Download Offline Maps", close: "Close" },
            hi: { title: "‡§∏‡§∞‡§≤", full_title: "‡§∏‡§∞‡§≤: ‡§è‡§Ü‡§à ‡§Ü‡§™‡§¶‡§æ ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ", status: "‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§ë‡§®‡§≤‡§æ‡§á‡§® | ‡§ú‡•á‡§Æ‡§ø‡§®‡•Ä 3.0 ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°", hazard_eye: "‚ú® ‡§ñ‡§§‡§∞‡§æ ‡§¶‡•É‡§∑‡•ç‡§ü‡§ø", hazard_modal_title: "‚ú® ‡§è‡§Ü‡§à ‡§ñ‡§§‡§∞‡§æ ‡§¶‡•É‡§∑‡•ç‡§ü‡§ø", hazard_btn_scan: "‚ú® ‡§è‡§Ü‡§à ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£", hazard_btn_send: "‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§ï‡•ã ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü", live_tracking: "‡§≤‡§æ‡§á‡§µ ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó", sos_title: "‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§è‡§∏‡§ì‡§è‡§∏", sos_sub: "‡§∏‡•ç‡§•‡§æ‡§® ‡§î‡§∞ ‡§Ü‡§à‡§°‡•Ä ‡§™‡•ç‡§∞‡§∏‡§æ‡§∞‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç", report_damage: "‡§ï‡•ç‡§∑‡§§‡§ø ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü", damage_sub: "‡§á‡§Ç‡§´‡•ç‡§∞‡§æ / ‡§∏‡§°‡§º‡§ï‡•á‡§Ç", report_missing: "‡§≤‡§æ‡§™‡§§‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü", missing_sub: "‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§∏‡§æ‡§∞‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç", face_scanner: "‡§ö‡•á‡§π‡§∞‡§æ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞", scanner_sub: "‡§≤‡•ã‡§ó ‡§ñ‡•ã‡§ú‡•á‡§Ç (‡§è‡§Ü‡§à)", volunteer: "‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡§ï", volunteer_sub: "‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß / ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç", damage_modal_title: "‡§ï‡•ç‡§∑‡§§‡§ø ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç", damage_btn_cancel: "‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç", damage_btn_submit: "‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç", missing_modal_title: "‡§ñ‡•ã‡§Ø‡§æ ‡§î‡§∞ ‡§™‡§æ‡§Ø‡§æ", missing_tab_person: "‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø", missing_tab_item: "‡§µ‡§∏‡•ç‡§§‡•Å", missing_btn_report: "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç", scanner_modal_title: "‡§ú‡•á‡§Æ‡§ø‡§®‡•Ä 3.0 ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§ñ‡•ã‡§ú‡§ï", scanner_btn_start: "‡§∏‡•ç‡§ï‡•à‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç", scanner_btn_stop: "‡§∞‡•ã‡§ï‡•ã", volunteer_modal_title: "‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø", volunteer_tab_req: "‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß", volunteer_tab_join: "‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç", volunteer_btn_post: "‡§™‡•ã‡§∏‡•ç‡§ü ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß", volunteer_btn_register: "‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡§∞‡•á‡§Ç", checklist_modal_title: "üéí ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä", check_gobag: "‡§ó‡•ã-‡§¨‡•à‡§ó ‡§™‡•à‡§ï ‡§ï‡§∞‡•á‡§Ç", check_contacts: "‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï", check_maps: "‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞", close: "‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç" },
            es: { title: "SARAL", full_title: "Saral: Respuesta IA Desastres", status: "SISTEMA EN L√çNEA | GEMINI 3.0", hazard_eye: "‚ú® Ojo de Peligro", hazard_modal_title: "‚ú® OJO DE PELIGRO IA", hazard_btn_scan: "‚ú® ANALIZAR IA", hazard_btn_send: "REPORTAR A HQ", live_tracking: "Rastreo en Vivo", sos_title: "SOS EMERGENCIA", sos_sub: "Transmitir Ubicaci√≥n e ID", report_damage: "Reportar Da√±o", damage_sub: "Infra / Carreteras", report_missing: "Reportar Desaparecido", missing_sub: "Emitir Alerta", face_scanner: "Esc√°ner Facial", scanner_sub: "Buscar Personas (IA)", volunteer: "Voluntario", volunteer_sub: "Solicitar / Unirse", damage_modal_title: "Reportar Da√±o", damage_btn_cancel: "Cancelar", damage_btn_submit: "Enviar", missing_modal_title: "Perdido y Encontrado", missing_tab_person: "Persona", missing_tab_item: "Objeto", missing_btn_report: "Reportar", scanner_modal_title: "Buscador Personas Gemini 3.0", scanner_btn_start: "Iniciar Escaneo", scanner_btn_stop: "Detener", volunteer_modal_title: "Comunidad", volunteer_tab_req: "Solicitar", volunteer_tab_join: "Unirse", volunteer_btn_post: "Publicar", volunteer_btn_register: "Registrar", checklist_modal_title: "üéí Lista de Preparaci√≥n", check_gobag: "Empacar Mochila", check_contacts: "Contactos Emergencia", check_maps: "Mapas Offline", close: "Cerrar" },
            ko: { title: "SARAL", full_title: "Saral: AI Ïû¨ÎÇú ÎåÄÏùë", status: "ÏãúÏä§ÌÖú Ïò®ÎùºÏù∏ | GEMINI 3.0 Ïó∞Í≤∞Îê®", hazard_eye: "‚ú® ÏúÑÌóò Í∞êÏßÄ", hazard_modal_title: "‚ú® AI ÏúÑÌóò Í∞êÏßÄ", hazard_btn_scan: "‚ú® AI Î∂ÑÏÑù", hazard_btn_send: "Î≥∏Î∂Ä Î≥¥Í≥†", live_tracking: "Ïã§ÏãúÍ∞Ñ Ï∂îÏ†Å", sos_title: "Í∏¥Í∏â SOS", sos_sub: "ÏúÑÏπò Ï†ÑÏÜ°", report_damage: "ÌîºÌï¥ Ïã†Í≥†", damage_sub: "ÎèÑÎ°ú / Í±¥Î¨º", report_missing: "Ïã§Ï¢Ö Ïã†Í≥†", missing_sub: "ÏïåÎ¶º Ï†ÑÏÜ°", face_scanner: "ÏñºÍµ¥ Ïä§Ï∫î", scanner_sub: "ÏÇ¨Îûå Ï∞æÍ∏∞ (AI)", volunteer: "ÏûêÏõêÎ¥âÏÇ¨", volunteer_sub: "ÏöîÏ≤≠ / Ï∞∏Ïó¨", damage_modal_title: "ÌîºÌï¥ Ïã†Í≥†", damage_btn_cancel: "Ï∑®ÏÜå", damage_btn_submit: "Ï†úÏ∂ú", missing_modal_title: "Î∂ÑÏã§Î¨º", missing_tab_person: "ÏÇ¨Îûå", missing_tab_item: "Î¨ºÍ±¥", missing_btn_report: "Ïã†Í≥†", scanner_modal_title: "Gemini 3.0 ÏÇ¨Îûå Ï∞æÍ∏∞", scanner_btn_start: "ÏãúÏûë", scanner_btn_stop: "Ï§ëÏßÄ", volunteer_modal_title: "Ïª§ÎÆ§ÎãàÌã∞", volunteer_tab_req: "ÏöîÏ≤≠", volunteer_tab_join: "Ï∞∏Ïó¨", volunteer_btn_post: "Í≤åÏãú", volunteer_btn_register: "Îì±Î°ù", checklist_modal_title: "üéí Ï§ÄÎπÑÎ¨º", check_gobag: "Í∞ÄÎ∞© Ïã∏Í∏∞", check_contacts: "ÎπÑÏÉÅ Ïó∞ÎùΩÏ≤ò", check_maps: "ÏßÄÎèÑ Îã§Ïö¥Î°úÎìú", close: "Îã´Í∏∞" },
            ja: { title: "SARAL", full_title: "Saral: AI ÁÅΩÂÆ≥ÂØæÂøú", status: "„Ç∑„Çπ„ÉÜ„É†„Ç™„É≥„É©„Ç§„É≥ | GEMINI 3.0 Êé•Á∂ö", hazard_eye: "‚ú® Âç±Èô∫Ê§úÁü•", hazard_modal_title: "‚ú® AI Âç±Èô∫Ê§úÁü•", hazard_btn_scan: "‚ú® AI ÂàÜÊûê", hazard_btn_send: "Êú¨ÈÉ®„Å∏Â†±Âëä", live_tracking: "„É©„Ç§„ÉñËøΩË∑°", sos_title: "Á∑äÊÄ• SOS", sos_sub: "‰ΩçÁΩÆÊÉÖÂ†±„ÇíÈÄÅ‰ø°", report_damage: "Ë¢´ÂÆ≥Â†±Âëä", damage_sub: "„Ç§„É≥„Éï„É© / ÈÅìË∑Ø", report_missing: "Ë°åÊñπ‰∏çÊòéÂ†±Âëä", missing_sub: "„Ç¢„É©„Éº„ÉàÈÄÅ‰ø°", face_scanner: "È°î„Çπ„Ç≠„É£„É≥", scanner_sub: "‰∫∫Êé¢„Åó (AI)", volunteer: "„Éú„É©„É≥„ÉÜ„Ç£„Ç¢", volunteer_sub: "‰æùÈ†º / ÂèÇÂä†", damage_modal_title: "Ë¢´ÂÆ≥Â†±Âëä", damage_btn_cancel: "„Ç≠„É£„É≥„Çª„É´", damage_btn_submit: "ÈÄÅ‰ø°", missing_modal_title: "ÈÅ∫Â§±Áâ©", missing_tab_person: "‰∫∫", missing_tab_item: "Áâ©", missing_btn_report: "Â†±Âëä", scanner_modal_title: "Gemini 3.0 ‰∫∫Êé¢„Åó", scanner_btn_start: "ÈñãÂßã", scanner_btn_stop: "ÂÅúÊ≠¢", volunteer_modal_title: "„Ç≥„Éü„É•„Éã„ÉÜ„Ç£", volunteer_tab_req: "‰æùÈ†º", volunteer_tab_join: "ÂèÇÂä†", volunteer_btn_post: "ÊäïÁ®ø", volunteer_btn_register: "ÁôªÈå≤", checklist_modal_title: "üéí Èò≤ÁÅΩ„É™„Çπ„Éà", check_gobag: "ÊåÅ„Å°Âá∫„ÅóË¢ã", check_contacts: "Á∑äÊÄ•ÈÄ£Áµ°ÂÖà", check_maps: "Âú∞Âõ≥‰øùÂ≠ò", close: "Èñâ„Åò„Çã" },
            zh: { title: "SARAL", full_title: "Saral: AI ÁÅæÂÆ≥ÂìçÂ∫î", status: "Á≥ªÁªüÂú®Á∫ø | GEMINI 3.0 Â∑≤ËøûÊé•", hazard_eye: "‚ú® Âç±Èô©ËØÜÂà´", hazard_modal_title: "‚ú® AI Âç±Èô©ËØÜÂà´", hazard_btn_scan: "‚ú® AI ÂàÜÊûê", hazard_btn_send: "Êä•ÂëäÊÄªÈÉ®", live_tracking: "ÂÆûÊó∂ËøΩË∏™", sos_title: "Á¥ßÊÄ• SOS", sos_sub: "ÂèëÈÄÅ‰ΩçÁΩÆ", report_damage: "Êä•ÂëäÂèóÊçü", damage_sub: "ËÆæÊñΩ / ÈÅìË∑Ø", report_missing: "Êä•ÂëäÂ§±Ë∏™", missing_sub: "ÂèëÂ∏ÉË≠¶Êä•", face_scanner: "‰∫∫ËÑ∏Êâ´Êèè", scanner_sub: "ÂØª‰∫∫ (AI)", volunteer: "ÂøóÊÑøËÄÖ", volunteer_sub: "ËØ∑Ê±Ç / Âä†ÂÖ•", damage_modal_title: "Êä•ÂëäÂèóÊçü", damage_btn_cancel: "ÂèñÊ∂à", damage_btn_submit: "Êèê‰∫§", missing_modal_title: "Â§±Áâ©ÊãõÈ¢Ü", missing_tab_person: "‰∫∫Âëò", missing_tab_item: "Áâ©ÂìÅ", missing_btn_report: "Êä•Âëä", scanner_modal_title: "Gemini 3.0 ÂØª‰∫∫", scanner_btn_start: "ÂºÄÂßã", scanner_btn_stop: "ÂÅúÊ≠¢", volunteer_modal_title: "Á§æÂå∫", volunteer_tab_req: "ËØ∑Ê±Ç", volunteer_tab_join: "Âä†ÂÖ•", volunteer_btn_post: "ÂèëÂ∏É", volunteer_btn_register: "Ê≥®ÂÜå", checklist_modal_title: "üéí Â∫îÊÄ•Ê∏ÖÂçï", check_gobag: "ÊâìÂåÖÂ∫îÊÄ•ÂåÖ", check_contacts: "Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫", check_maps: "Á¶ªÁ∫øÂú∞Âõæ", close: "ÂÖ≥Èó≠" }
        };

        function changeLanguage(lang) {
            document.documentElement.lang = lang;
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });
            // Update placeholders manually
            let p1 = "e.g., How to stop bleeding?", p2 = "Describe person...";
            if (lang === 'hi') { p1 = "‡§ú‡•à‡§∏‡•á: ‡§ñ‡•Ç‡§® ‡§¨‡§π‡§®‡§æ ‡§ï‡•à‡§∏‡•á ‡§∞‡•ã‡§ï‡•á‡§Ç?"; p2 = "‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§ï‡§æ ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç..."; }
            else if (lang === 'es') { p1 = "ej., ¬øC√≥mo detener sangrado?"; p2 = "Describir persona..."; }
            else if (lang === 'ko') { p1 = "Ïòà: ÏßÄÌòà Î∞©Î≤ï?"; p2 = "ÏÇ¨Îûå ÏÑ§Î™Ö..."; }
            else if (lang === 'ja') { p1 = "‰æã: Âá∫Ë°Ä„ÇíÊ≠¢„ÇÅ„Çã„Å´„ÅØÔºü"; p2 = "‰∫∫Áâ©„ÅÆÁâπÂæ¥..."; }
            else if (lang === 'zh') { p1 = "‰æãÂ¶ÇÔºöÂ¶Ç‰ΩïÊ≠¢Ë°ÄÔºü"; p2 = "ÊèèËø∞‰∫∫Âëò..."; }

            const promptEl = document.getElementById('ai-prompt');
            if (promptEl) promptEl.placeholder = p1;
            const scanTarget = document.getElementById('scan-target');
            if (scanTarget) scanTarget.placeholder = p2;
        }

        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                icon.className = 'fas fa-moon';
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                icon.className = 'fas fa-sun';
            }
        }
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-icon').className = 'fas fa-sun';
        }

        // --- TOAST FUNCTION ---
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = "toast";
            toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            container.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transition = "opacity 0.5s, transform 0.5s";
                toast.style.opacity = "0";
                toast.style.transform = "translateY(20px) scale(0.9)";
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        async function callGemini(text, imageBase64 = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const lang = document.documentElement.lang || 'en';
            let langName = 'English';
            if (lang === 'hi') langName = 'Hindi';
            else if (lang === 'es') langName = 'Spanish';
            else if (lang === 'ko') langName = 'Korean';
            else if (lang === 'ja') langName = 'Japanese';
            else if (lang === 'zh') langName = 'Mandarin Chinese';

            const finalText = text + ` (Please respond in ${langName} language)`;
            const parts = [{ text: finalText }];
            if (imageBase64) {
                const cleanBase64 = imageBase64.replace(/^data:image\/(png|jpg|jpeg);base64,/, "");
                parts.push({ inline_data: { mime_type: "image/jpeg", data: cleanBase64 } });
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });
                if (!response.ok) throw new Error("API Request Failed: " + response.status);
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Gemini connection failed.";
            }
        }

        // --- GLOBAL VARS ---
        let hazardStream;
        let currentHazardImage = null;
        let map, userMarker = null;
        let lastLocation = null;
        const startLoc = [28.6139, 77.2090];

        // --- CORE SETUP ---
        let socket;
        const eventListeners = {};

        // Create a robust mock socket that uses localStorage for cross-tab communication
        function createMockSocket() {
            return {
                emit: (type, data) => {
                    console.log('[LocalBridge-Emit]', type, data);
                },
                on: (type, fn) => {
                    if (!eventListeners[type]) eventListeners[type] = [];
                    eventListeners[type].push(fn);
                }
            };
        }

        // Listen for events from Command Center (admin broadcasts)
        window.addEventListener('storage', (event) => {
            if (event.key === 'saral_event_bus' && event.newValue) {
                try {
                    const data = JSON.parse(event.newValue);
                    const type = data.type;
                    if (eventListeners[type]) {
                        eventListeners[type].forEach(fn => fn(data));
                    }
                    // Handle disaster alerts
                    if (type === 'DISASTER_ALERT') {
                        alert('‚ö†Ô∏è DISASTER ALERT: ' + (data.alertType || data.details));
                    }
                } catch (e) { console.error('Event parse error', e); }
            }
        });

        try {
            if (typeof io !== 'undefined') {
                socket = io({
                    timeout: 3000,
                    reconnectionAttempts: 2
                });

                // If connection fails, fall back to mock
                socket.on('connect_error', () => {
                    console.warn("Socket.IO connection failed, switching to LocalBridge mode");
                    socket = createMockSocket();
                });
            } else {
                throw new Error("Socket.IO not loaded");
            }
        } catch (e) {
            console.warn("LocalBridge Mode Active");
            socket = createMockSocket();
        }
        const channel = {
            postMessage: (data) => {
                const payload = { ...data, timestamp: Date.now() };
                localStorage.setItem('saral_event_bus', JSON.stringify(payload));
                if (socket && socket.emit) socket.emit(data.type, data);
            }
        };
        const USER_ID = 'CITIZEN-' + Math.floor(Math.random() * 10000);
        document.getElementById('user-id-display').innerText = USER_ID;

        // --- MAP ---
        window.addEventListener('load', () => {
            map = L.map('map').setView(startLoc, 13);
            // NEW (FIXED)
            L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                attribution: 'Google Satellite'
            }).addTo(map);

            // Added this line to fix gray box issues on mobile resize
            setTimeout(() => { map.invalidateSize(); }, 500);
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const newLoc = [lat, lng];

                    lastLocation = { lat, lng };

                    if (!userMarker) {
                        userMarker = L.marker(newLoc).addTo(map).bindPopup("You are here").openPopup();
                        map.setView(newLoc, 16);
                    } else userMarker.setLatLng(newLoc);

                    channel.postMessage({ type: 'LOCATION_UPDATE', userId: USER_ID, location: `${lat}, ${lng}`, time: new Date().toLocaleTimeString() });
                });
            }
        });

        // --- RESTORED LOGIC: DAMAGE ---
        function submitDamageReport(e) {
            e.preventDefault();
            const type = document.getElementById('damage-type').value;
            const desc = document.getElementById('damage-desc').value;
            const loc = lastLocation ? `${lastLocation.lat}, ${lastLocation.lng}` : "Unknown";
            channel.postMessage({ type: 'DAMAGE_REPORT', userId: USER_ID, details: `${type}: ${desc}`, location: loc, time: new Date().toLocaleTimeString() });
            alert("Damage Reported!");
            document.getElementById('damage-modal').classList.add('hidden');
            e.target.reset();
        }

        // --- RESTORED LOGIC: LOST & FOUND ---
        function toggleLostTab(tab) {
            const tabPerson = document.getElementById('tab-person');
            const tabItem = document.getElementById('tab-item');

            if (tab === 'person') {
                document.getElementById('form-person').classList.remove('hidden');
                document.getElementById('form-item').classList.add('hidden');
                tabPerson.className = "px-3 py-1 rounded bg-purple-600 text-white text-xs font-bold transition";
                tabItem.className = "px-3 py-1 rounded text-gray-500 dark:text-gray-400 text-xs font-bold transition hover:bg-gray-200 dark:hover:bg-gray-700";
            } else {
                document.getElementById('form-person').classList.add('hidden');
                document.getElementById('form-item').classList.remove('hidden');
                tabItem.className = "px-3 py-1 rounded bg-gray-700 text-white text-xs font-bold transition";
                tabPerson.className = "px-3 py-1 rounded text-gray-500 dark:text-gray-400 text-xs font-bold transition hover:bg-gray-200 dark:hover:bg-gray-700";
            }
        }

        function submitLostReport(e, cat) {
            e.preventDefault();
            const loc = lastLocation ? `${lastLocation.lat}, ${lastLocation.lng}` : "Unknown";

            // Handle Photo Upload
            if (cat === 'person') {
                const fileInput = document.getElementById('p-image');
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        const base64Img = evt.target.result;
                        const missingPersonData = {
                            name: document.getElementById('p-name').value,
                            desc: document.getElementById('p-desc').value,
                            image: base64Img,
                            id: 'MISSING-' + Date.now()
                        };
                        let missingList = JSON.parse(localStorage.getItem('saral_missing_list') || '[]');
                        missingList.push(missingPersonData);
                        localStorage.setItem('saral_missing_list', JSON.stringify(missingList));

                        const details = `Missing: ${missingPersonData.name} (${document.getElementById('p-age').value}). Desc: ${missingPersonData.desc}`;
                        channel.postMessage({
                            type: 'MISSING_PERSON',
                            userId: USER_ID,
                            details: details,
                            image: base64Img,
                            location: loc,
                            time: new Date().toLocaleTimeString()
                        });
                        alert("Missing Person Reported (With Photo)!");
                        document.getElementById('lost-modal').classList.add('hidden');
                        e.target.reset();
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                    return;
                }
            }

            let details = cat === 'person'
                ? `Missing: ${document.getElementById('p-name').value} (${document.getElementById('p-age').value})`
                : `Lost Item: ${document.getElementById('i-desc').value}`;

            channel.postMessage({
                type: cat === 'person' ? 'MISSING_PERSON' : 'LOST_ITEM',
                userId: USER_ID,
                details: details,
                location: loc,
                time: new Date().toLocaleTimeString()
            });
            alert("Report Submitted!");
            document.getElementById('lost-modal').classList.add('hidden');
            e.target.reset();
        }

        // --- RESTORED LOGIC: VOLUNTEER ---
        function toggleVolTab(tab) {
            const tabReq = document.getElementById('tab-request');
            const tabJoin = document.getElementById('tab-join');
            if (tab === 'request') {
                document.getElementById('form-request').classList.remove('hidden');
                document.getElementById('form-join').classList.add('hidden');
                tabReq.className = "px-3 py-1 rounded bg-teal-600 text-white text-xs font-bold transition";
                tabJoin.className = "px-3 py-1 rounded text-gray-500 dark:text-gray-400 text-xs font-bold transition hover:bg-gray-200 dark:hover:bg-gray-700";
            } else {
                document.getElementById('form-request').classList.add('hidden');
                document.getElementById('form-join').classList.remove('hidden');
                tabJoin.className = "px-3 py-1 rounded bg-blue-600 text-white text-xs font-bold transition";
                tabReq.className = "px-3 py-1 rounded text-gray-500 dark:text-gray-400 text-xs font-bold transition hover:bg-gray-200 dark:hover:bg-gray-700";
            }
        }
        function submitVolunteer(e, cat) {
            e.preventDefault();
            const loc = lastLocation ? `${lastLocation.lat}, ${lastLocation.lng}` : "Unknown";
            let details = cat === 'request'
                ? `Request: ${document.getElementById('req-qty').value}x ${document.getElementById('req-type').value}`
                : `Volunteer: ${document.getElementById('vol-name').value} (${document.getElementById('vol-skill').value})`;
            channel.postMessage({ type: cat === 'request' ? 'HELP_REQUEST' : 'VOLUNTEER_JOIN', userId: USER_ID, details: details, location: loc, time: new Date().toLocaleTimeString() });
            alert(cat === 'request' ? "Request Posted" : "Registered!");
            document.getElementById('volunteer-modal').classList.add('hidden');
        }

        // --- RESTORED LOGIC: MANUAL HEALTH ---
        function reportHealth(severity) {
            const loc = lastLocation ? `${lastLocation.lat}, ${lastLocation.lng}` : "Unknown";
            channel.postMessage({ type: 'MEDICAL_REPORT', userId: USER_ID, severity: severity.toLowerCase(), details: `Manual Report: ${severity}`, location: loc, time: new Date().toLocaleTimeString() });
            alert(`Medical Alert Sent: ${severity}`);
        }

        // --- AI LOGIC (UPDATED WITH GEMINI) ---
        async function openHazardModal() {
            document.getElementById('hazard-modal').classList.remove('hidden');
            try { hazardStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); document.getElementById('hazard-video').srcObject = hazardStream; } catch (e) { alert("Cam Error"); }
        }
        function closeHazardModal() { document.getElementById('hazard-modal').classList.add('hidden'); if (hazardStream) hazardStream.getTracks().forEach(t => t.stop()); document.getElementById('hazard-analysis-box').classList.add('hidden'); document.getElementById('btn-hazard-scan').classList.remove('hidden'); document.getElementById('btn-hazard-send').classList.add('hidden'); }

        async function analyzeHazard() {
            document.getElementById('hazard-scan-line').classList.remove('hidden');
            document.getElementById('btn-hazard-scan').innerText = "ANALYZING...";

            const video = document.getElementById('hazard-video');
            const canvas = document.getElementById('hazard-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            currentHazardImage = canvas.toDataURL('image/jpeg', 0.8);

            const prompt = "Analyze this image for disaster hazards. Identify the main hazard and estimate severity (CRITICAL, MODERATE, MINOR). Format: 'Hazard: [Description] | Severity: [Level]'";
            const resultText = await callGemini(prompt, currentHazardImage);

            // Parse Result
            let displayText = resultText;
            let severity = null;

            if (resultText.includes("|")) {
                const parts = resultText.split("|");
                displayText = parts[0].replace("Hazard:", "").trim();
                const sevPart = parts[1].replace("Severity:", "").trim().toUpperCase();
                if (sevPart.includes("CRITICAL")) severity = "CRITICAL";
                else if (sevPart.includes("MODERATE")) severity = "MODERATE";
                else if (sevPart.includes("MINOR")) severity = "MINOR";
            }

            document.getElementById('hazard-scan-line').classList.add('hidden');
            document.getElementById('hazard-analysis-box').classList.remove('hidden');
            document.getElementById('hazard-text').innerText = displayText;

            const badge = document.getElementById('hazard-severity-badge');
            const badgeContainer = document.getElementById('hazard-badge-container');

            if (severity) {
                badgeContainer.classList.remove('hidden');
                badge.innerText = "SEVERITY: " + severity;
                badge.className = "px-2 py-0.5 rounded text-[10px] font-bold text-white border border-white/20 " +
                    (severity === "CRITICAL" ? "bg-red-600 animate-pulse shadow-[0_0_10px_rgba(220,38,38,0.7)]" : (severity === "MODERATE" ? "bg-yellow-600" : "bg-green-600"));
            } else {
                badgeContainer.classList.add('hidden');
            }

            document.getElementById('btn-hazard-scan').classList.add('hidden');
            document.getElementById('btn-hazard-send').classList.remove('hidden');
        }

        function sendHazardReport() {
            let details = document.getElementById('hazard-text').innerText;
            const badge = document.getElementById('hazard-severity-badge');
            if (!badge.parentElement.classList.contains('hidden')) {
                details += ` [${badge.innerText}]`;
            }
            const loc = lastLocation ? `${lastLocation.lat}, ${lastLocation.lng}` : "Unknown";

            channel.postMessage({
                type: 'HAZARD_REPORT',
                userId: USER_ID,
                details: details,
                isAiGenerated: true,
                image: currentHazardImage,
                location: loc,
                time: new Date().toLocaleTimeString()
            });
            // FIX: Specific Toast Message
            showToast("üß† Gemini intelligence transmitted to Command Center");
            closeHazardModal();
        }

        // --- SOS ---
        async function sendSOS() {
            const loc = lastLocation ? `${lastLocation.lat}, ${lastLocation.lng}` : "Unknown";

            // UI Feedback for recording
            showToast("üéôÔ∏è Recording 3s Audio Clip...");

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const recorder = new MediaRecorder(stream);
                let chunks = [];

                recorder.ondataavailable = e => chunks.push(e.data);

                recorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    // Convert to Base64
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        const base64Audio = reader.result;

                        channel.postMessage({
                            type: 'SOS',
                            userId: USER_ID,
                            details: "PANIC BUTTON",
                            location: loc,
                            audio: base64Audio,
                            time: new Date().toLocaleTimeString()
                        });
                        showToast("üÜò Distress Signal Broadcasted with Audio!");

                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                    };
                };

                recorder.start();
                setTimeout(() => {
                    recorder.stop();
                }, 3000);

            } catch (err) {
                console.error("Audio recording failed", err);
                // Fallback sending without audio
                channel.postMessage({ type: 'SOS', userId: USER_ID, details: "PANIC BUTTON (Audio Failed)", location: loc, time: new Date().toLocaleTimeString() });
                showToast("üÜò Distress Signal Broadcasted (No Audio)!");
            }
        }
    </script>
</body>

</html>