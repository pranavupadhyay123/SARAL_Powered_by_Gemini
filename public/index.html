<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saral: Smart Alert and Resilient Aid Layer - Central Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        #admin-map { height: 100%; width: 100%; z-index: 1; min-height: 350px; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        
        .ai-glow { animation: glow 2s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px #3b82f6; } to { box-shadow: 0 0 20px #3b82f6, 0 0 10px #ffffff; } }

        /* Severity Colors for Rows */
        .row-critical { background: rgba(220, 38, 38, 0.15) !important; border-left: 4px solid #dc2626 !important; }
        .row-moderate { background: rgba(234, 179, 8, 0.15) !important; border-left: 4px solid #eab308 !important; }
        .row-minor { background: rgba(34, 197, 94, 0.15) !important; border-left: 4px solid #22c55e !important; }
    </style>
</head>

<body class="bg-gray-900 text-gray-200 font-sans min-h-screen lg:h-screen lg:overflow-hidden flex flex-col">

    <!-- NAVBAR -->
    <nav class="bg-black/50 backdrop-blur-md text-white p-3 border-b border-gray-700 flex-shrink-0 relative z-20">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600/20 p-2 rounded-lg border border-blue-500/50">
                    <i class="fas fa-shield-alt text-2xl text-blue-400"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-widest text-white uppercase">
                        SARAL <span class="text-blue-500">COMMAND</span>
                    </h1>
                    <p class="text-[10px] text-gray-400 uppercase tracking-[0.2em]">AI-Powered Disaster Response</p>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <div class="hidden md:flex flex-col text-right">
                    <span class="text-[10px] text-gray-500 font-bold uppercase">Gemini Intelligence</span>
                    <span class="text-xs text-green-400 font-mono"><i class="fas fa-circle text-[8px] animate-pulse"></i> 3 ENGINE READY</span>
                </div>
                <!-- Sim Button -->
                <button onclick="simulateIncident()" class="bg-purple-700 hover:bg-purple-600 text-white text-xs px-3 py-1 rounded border border-purple-500">
                    <i class="fas fa-random"></i> Sim Incident
                </button>
                <div class="bg-gray-800 px-3 py-1 rounded border border-gray-600 text-right">
                    <div class="text-[10px] text-gray-400 font-bold uppercase">Active Units</div>
                    <div class="text-xl font-mono font-bold text-white leading-none" id="active-count">0</div>
                </div>
                <span id="clock" class="hidden sm:block text-gray-500 font-mono text-lg">00:00:00</span>
            </div>
        </div>
    </nav>

    <div class="flex-grow p-4 grid grid-cols-1 lg:grid-cols-4 gap-4 overflow-y-auto lg:overflow-hidden relative z-10">

        <!-- LEFT PANEL: FEED & AI ALERTS -->
        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 lg:col-span-1 flex flex-col gap-4 h-full overflow-hidden custom-scroll overflow-y-auto">
            
            <!-- AI INTELLIGENCE FEED -->
            <div class="bg-blue-900/10 border border-blue-500/30 p-3 rounded-lg relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                <h3 class="text-xs font-bold text-blue-400 uppercase mb-3 flex justify-between items-center">
                    <span><i class="fas fa-robot mr-1"></i> Live Intel Feed</span>
                    <span class="bg-blue-600 text-white text-[9px] px-1.5 rounded">AUTO</span>
                </h3>
                <div id="ai-feed" class="space-y-2 text-xs min-h-[100px]">
                    <div class="text-gray-500 text-center italic py-4">Waiting for intel...</div>
                </div>
            </div>

            <!-- DISASTER CONTROL -->
            <div class="bg-red-900/10 border border-red-500/30 p-4 rounded-xl shadow-sm shrink-0">
                <h2 class="text-sm font-bold text-red-400 mb-3 uppercase tracking-wide"><i class="fas fa-bullhorn"></i> Broadcast Alert</h2>
                <div class="space-y-3">
                    <select id="disaster-type" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-white focus:outline-none focus:border-red-500">
                        <option value="FLOOD">üåä Flood Warning</option>
                        <option value="EARTHQUAKE">üìâ Earthquake</option>
                        <option value="FIRE">üî• Fire Hazard</option>
                    </select>
                    <button onclick="declareDisaster()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded shadow text-xs tracking-wider">
                        TRANSMIT ALERT
                    </button>
                </div>
            </div>

            <!-- MISSION STATEMENT -->
            <div class="mt-auto pt-4 border-t border-gray-700">
                <p class="text-[10px] text-gray-500 text-center italic">
                    "SARAL uses Gemini as a centralized incident intelligence engine that classifies, prioritizes, and guides response across all modules."
                </p>
            </div>
        </div>

        <!-- CENTER PANEL: MAP -->
        <div class="lg:col-span-2 flex flex-col gap-4 h-full">
            <!-- MAP -->
            <div class="bg-gray-800 p-1 rounded-xl shadow-lg border border-gray-700 relative flex-grow h-[60%]">
                 <div class="absolute top-4 right-4 z-[500] bg-black/80 px-3 py-1 rounded text-xs font-mono border border-gray-600 backdrop-blur-sm text-green-400">
                    <i class="fas fa-satellite"></i> SAT-LINK: ACTIVE
                </div>
                <div id="admin-map" class="rounded border border-gray-600 h-full w-full bg-gray-900"></div>
            </div>

            <!-- INCIDENTS TABLE -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 flex-grow h-[35%] flex flex-col overflow-hidden">
                <div class="bg-gray-900/50 p-2 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-sm font-bold text-gray-300 ml-2">Incoming Incident Log</h2>
                    <button onclick="document.getElementById('incident-table').innerHTML = ''" class="text-[10px] bg-gray-700 px-2 py-1 rounded hover:bg-gray-600">Clear</button>
                </div>
                <div class="overflow-auto custom-scroll flex-1">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-700 text-gray-400 sticky top-0">
                            <tr>
                                <th class="p-2">Time</th>
                                <th class="p-2">Source</th>
                                <th class="p-2">Type</th>
                                <th class="p-2">Details</th>
                                <th class="p-2">Action</th>
                            </tr>
                        </thead>
                        <tbody id="incident-table" class="divide-y divide-gray-700 text-gray-300">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: RESOURCES -->
        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 lg:col-span-1 flex flex-col gap-4 overflow-y-auto custom-scroll">
            
            <!-- Triage Board -->
            <div class="bg-gray-900 border border-gray-600 p-3 rounded-lg">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Casualty Triage</h3>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-red-900/30 border border-red-800 rounded p-2">
                        <div class="text-xl font-bold text-red-500" id="count-critical">0</div>
                        <div class="text-[9px] text-red-300 uppercase">Critical</div>
                    </div>
                    <div class="bg-yellow-900/30 border border-yellow-800 rounded p-2">
                        <div class="text-xl font-bold text-yellow-500" id="count-moderate">0</div>
                        <div class="text-[9px] text-yellow-300 uppercase">Moderate</div>
                    </div>
                    <div class="bg-green-900/30 border border-green-800 rounded p-2">
                        <div class="text-xl font-bold text-green-500" id="count-minor">0</div>
                        <div class="text-[9px] text-green-300 uppercase">Minor</div>
                    </div>
                </div>
            </div>

            <!-- Resources -->
             <div class="bg-gray-900 border border-gray-600 p-3 rounded-lg flex-grow">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Resource Deployment</h3>
                <div class="space-y-3 text-xs">
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span>üöë Ambulances</span>
                        <span class="text-green-400 font-mono">12/20</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span>üöí Fire Units</span>
                        <span class="text-green-400 font-mono">05/08</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span>üöÅ Drone Squad</span>
                        <span class="text-blue-400 font-mono">READY</span>
                    </div>
                </div>
                <button class="w-full mt-4 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs font-bold">DISPATCH ALL</button>
            </div>

        </div>

    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div id="image-modal" class="hidden fixed inset-0 z-[2100] bg-black/90 flex items-center justify-center p-4 backdrop-blur-md" onclick="closeImageModal()">
        <div class="relative max-w-4xl w-full" onclick="event.stopPropagation()">
            <button onclick="closeImageModal()" class="absolute -top-12 right-0 text-white hover:text-gray-300 text-2xl">
                <i class="fas fa-times"></i>
            </button>
            <img id="full-image" src="" class="w-full h-auto max-h-[80vh] object-contain rounded-lg shadow-2xl border border-gray-700">
            <div class="mt-4 bg-gray-800 p-4 rounded-lg border border-gray-700">
                <h3 class="text-lg font-bold text-white mb-2" id="image-title">Details</h3>
                <p class="text-gray-300 text-sm" id="image-desc">No details provided.</p>
            </div>
        </div>
    </div>

    <!-- GEMINI INTELLIGENCE MODAL -->
    <div id="intel-modal" class="hidden fixed inset-0 z-[2200] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-2xl rounded-2xl border border-blue-500/50 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-900 to-gray-900 p-4 border-b border-blue-500/30 flex justify-between items-center">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-brain text-blue-400"></i> Gemini 2.5 Incident Intelligence
                </h2>
                <button onclick="document.getElementById('intel-modal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Content -->
            <div id="intel-content" class="p-6 overflow-y-auto flex-grow custom-scroll">
                <!-- Dynamic Content Here -->
                <div class="flex flex-col items-center justify-center h-40 text-blue-300">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i>
                    <p class="animate-pulse text-sm">Gemini 2.5 is analyzing chaos patterns...</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-800 p-3 border-t border-gray-700 flex justify-end">
                <button onclick="document.getElementById('intel-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded font-bold">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- SOCKET.IO CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const GEMINI_API_KEY = "AIzaSyAJa6WXkcKA1fyVqaOV5KG5PdtQvB3r0Es";

        // --- CORE SETUP ---
        let socket;
        try {
            if (typeof io !== 'undefined') {
                socket = io();
            } else {
                throw new Error("Socket.IO not loaded");
            }
        } catch (e) {
            console.warn("Socket.IO not initialized (Offline Mode):", e);
            socket = {
                emit: (type, data) => console.log('[Mock-Emit]', type, data),
                on: (type, fn) => console.log('[Mock-On] Registered:', type)
            };
        }

        // --- LOCAL BRIDGE LISTENER ---
        window.addEventListener('storage', (event) => {
            if (event.key === 'saral_event_bus' && event.newValue) {
                const data = JSON.parse(event.newValue);
                handleIncident(data);
            }
        });

        const activeUsers = {};
        const triageCounts = { critical: 0, moderate: 0, minor: 0 };
        let map;

        // --- MAP INITIALIZATION ---
        window.addEventListener('load', () => {
            map = L.map('admin-map', {
                center: [28.6139, 77.2090], // Delhi Center
                zoom: 5,
                zoomControl: false
            });
            
            // NEW (FIXED)
L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{
    maxZoom: 20,
    attribution: 'Google Satellite'
}).addTo(map);

// Added this line to fix gray box issues on load
setTimeout(() => { map.invalidateSize(); }, 500);

            L.control.zoom({ position: 'bottomright' }).addTo(map);
        });

        // --- SOCKET LISTENER ---
        if(socket.on) {
            socket.on('LOCATION_UPDATE', (data) => updateMapMarker(data));
            const events = ['SOS', 'HAZARD_REPORT', 'MEDICAL_REPORT', 'VOLUNTEER_JOIN', 'MISSING_PERSON', 'FOUND_PERSON'];
            events.forEach(type => {
                socket.on(type, (data) => {
                    handleIncident(data);
                });
            });
        }

        function updateMapMarker(data) {
            if (!data.location || !data.location.includes(',')) return;
            const [lat, lng] = data.location.split(',').map(Number);
            
            if (activeUsers[data.userId]) {
                activeUsers[data.userId].setLatLng([lat, lng]);
            } else {
                const marker = L.circleMarker([lat, lng], {
                    radius: 4, color: '#4ade80', fillColor: '#4ade80', fillOpacity: 0.8
                }).addTo(map);
                marker.bindPopup(`User: ${data.userId}`);
                activeUsers[data.userId] = marker;
                document.getElementById('active-count').innerText = Object.keys(activeUsers).length;
            }
        }

        // --- MAIN INCIDENT HANDLER ---
        function handleIncident(data) {
            const table = document.getElementById('incident-table');
            const row = document.createElement('tr');
            
            // Assign Unique ID for Gemini Tracking
            const incidentId = `inc_${Date.now()}_${Math.floor(Math.random()*1000)}`;
            row.id = incidentId;
            window[incidentId] = data; // Store global ref

            row.className = "border-b border-gray-700 hover:bg-gray-800 animate-fade-in transition-all duration-500";
            
            let typeBadge = `<span class="bg-gray-600 px-1 rounded text-[10px]">${data.type}</span>`;
            let aiBadge = data.isAiGenerated ? `<span class="text-blue-400 font-bold text-[10px]"><i class="fas fa-robot"></i> AI</span>` : ``;
            
            if(data.type === 'SOS') typeBadge = `<span class="bg-red-600 text-white px-1 rounded text-[10px] animate-pulse">SOS</span>`;
            if(data.type === 'HAZARD_REPORT') typeBadge = `<span class="bg-orange-600 text-white px-1 rounded text-[10px]">HAZARD</span>`;
            if(data.type === 'MISSING_PERSON') typeBadge = `<span class="bg-purple-600 text-white px-1 rounded text-[10px]">MISSING</span>`;

            // Actions Buttons
            let actionBtns = `<div class="flex gap-1">`;
            
            // 1. Analyze Button (Gemini Intelligence)
            actionBtns += `<button onclick="generateIntel('${incidentId}')" class="bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] px-2 py-1 rounded border border-indigo-500"><i class="fas fa-bolt"></i> Analyze</button>`;

            // 2. View Image Button
            if(data.image) {
                actionBtns += `<button onclick="viewImage('${data.image}', '${data.type}', '${data.details.replace(/'/g, "\\'")}')" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] px-2 py-1 rounded"><i class="fas fa-image"></i> View</button>`;
            }
            
            // 3. Acknowledge Button
            actionBtns += `<button onclick="acknowledgeAlert(this)" class="bg-transparent border border-green-500 text-green-500 hover:bg-green-500 hover:text-white text-[10px] px-2 py-1 rounded transition">ACK</button>`;
            actionBtns += `</div>`;

            row.innerHTML = `
                <td class="p-2 font-mono text-gray-500">${data.time}</td>
                <td class="p-2 font-bold">${data.userId}</td>
                <td class="p-2">${typeBadge}</td>
                <td class="p-2 text-xs truncate max-w-[200px]" title="${data.details}">${data.details} ${aiBadge}</td>
                <td class="p-2">${actionBtns}</td>
            `;
            table.prepend(row);

            // Left Feed Logic
            if(data.isAiGenerated || data.type === 'MISSING_PERSON' || data.type === 'FOUND_PERSON') {
                const feed = document.getElementById('ai-feed');
                const item = document.createElement('div');
                let borderColor = data.type === 'MISSING_PERSON' ? 'border-purple-500' : 'border-blue-500';
                let icon = data.type === 'MISSING_PERSON' ? 'fa-user-slash' : 'fa-robot';
                
                item.className = `bg-gray-800/50 border-l-2 ${borderColor} p-2 animate-fade-in mb-2 rounded shadow-sm`;
                
                let imgSrc = data.image ? `<img src="${data.image}" class="w-full h-24 object-cover rounded mt-2 cursor-pointer border border-gray-600 hover:opacity-80 transition" onclick="viewImage('${data.image}', 'Report Details', '${data.details}')">` : '';

                item.innerHTML = `
                    <div class="text-[10px] font-bold mb-1 flex justify-between text-gray-300">
                        <span><i class="fas ${icon}"></i> ${data.type}</span>
                        <span class="text-gray-500">${data.time}</span>
                    </div>
                    <div class="text-gray-300 leading-tight text-xs font-mono mb-2">${data.details}</div>
                    <button onclick="generateIntel('${incidentId}')" class="w-full bg-indigo-900/50 hover:bg-indigo-900 text-indigo-300 text-[10px] py-1 rounded border border-indigo-700/50 mb-1"><i class="fas fa-brain"></i> Generate Intel</button>
                    ${imgSrc}
                `;
                
                if(feed.children[0] && feed.children[0].innerText.includes('Waiting')) feed.innerHTML = '';
                feed.prepend(item);
            }

            // Triage Logic
            if(data.type === 'MEDICAL_REPORT' && data.severity) {
                const s = data.severity.toLowerCase();
                if(triageCounts[s] !== undefined) {
                    triageCounts[s]++;
                    document.getElementById(`count-${s}`).innerText = triageCounts[s];
                }
            }

            // Map Logic
            if(data.location && data.location.includes(',')) {
                const [lat, lng] = data.location.split(',').map(Number);
                if(!isNaN(lat) && !isNaN(lng)) {
                    let color = data.type === 'HAZARD_REPORT' ? 'orange' : (data.type === 'SOS' ? 'red' : 'purple');
                    let iconClass = data.type === 'HAZARD_REPORT' ? 'fa-exclamation-triangle' : (data.type === 'SOS' ? 'fa-broadcast-tower' : 'fa-user');
                    const iconHtml = `<div class="text-${color}-500 text-lg shadow-black drop-shadow-md"><i class="fas ${iconClass}"></i></div>`;
                    L.marker([lat, lng], { icon: L.divIcon({ html: iconHtml, className: '' }) }).addTo(map)
                     .bindPopup(`<strong class="text-black">${data.type}</strong><br><span class="text-black">${data.details}</span>`);
                }
            }
        }

        // --- GEMINI INTELLIGENCE ENGINE ---
        async function generateIntel(incidentKey) {
            const data = window[incidentKey];
            if(!data) return alert("Incident data not found.");

            // Show Modal
            document.getElementById('intel-modal').classList.remove('hidden');
            const contentDiv = document.getElementById('intel-content');
            contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-blue-300"><i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i><p class="animate-pulse text-sm">Gemini 2.5 is analyzing chaos patterns...</p></div>`;

            // Prepare Prompt
            const prompt = `
                You are a Disaster Response Commander AI. Analyze this raw incident report and produce a JSON response.
                
                INCIDENT DATA:
                Type: ${data.type}
                Details: ${data.details}
                Severity (Reported): ${data.severity || 'Unknown'}
                Time: ${data.time}
                
                REQUIREMENTS:
                1. Determine the probable "incident_type" (e.g., Structural Collapse, Flood, Medical Emergency).
                2. Assess "severity" (CRITICAL, MODERATE, MINOR).
                3. Give a "confidence" score (0.0 - 1.0).
                4. Provide 2-3 bullet points of "reasoning" based on the data.
                5. List 3 specific "recommended_actions" steps for the response team.
                6. Analyze background audio if present. Classify audio as one of:
                   - FIRE
                   - FLOOD
                   - CROWD PANIC
                   - SILENCE
                   - UNKNOWN

                OUTPUT FORMAT:
                Return ONLY valid JSON. No markdown. Structure:
                {
                  "incident_type": "string",
                  "severity": "string",
                  "confidence": number,
                  "reasoning": ["string", "string"],
                  "recommended_actions": ["string", "string"],
                  "audio_signal": "string"
                }
            `;

            let parts = [{ text: prompt }];
            if(data.image) {
                const cleanBase64 = data.image.replace(/^data:image\/(png|jpg|jpeg);base64,/, "");
                parts.push({ inline_data: { mime_type: "image/jpeg", data: cleanBase64 } });
            }
            if (data.audio) {
                const cleanAudio = data.audio.split(',')[1];
                parts.push({
                    inline_data: {
                        mime_type: "audio/webm",
                        data: cleanAudio
                    }
                });
            }

            try {
                // FIXED: REVERTED TO GEMINI 2.5 FLASH PREVIEW
                const ADMIN_MODEL = "gemini-2.5-flash-preview-09-2025";
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${ADMIN_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(url, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    contents: [
                      {
                        parts: parts
                      }
                    ]
                  })
                });

                if(!response.ok) throw new Error("AI API Failed");
                
                const result = await response.json();
                const rawText = result.candidates[0].content.parts[0].text;
                const jsonStr = rawText.replace(/```json|```/g, '').trim(); 
                const intel = JSON.parse(jsonStr);

                // Render Result
                renderIntelUI(intel, data.image);

                // FIX 1: APPLY GEMINI DECISIONS SYSTEM-WIDE
                applyGeminiDecisions(incidentKey, intel);

            } catch(e) {
                console.error(e);
                contentDiv.innerHTML = `<div class="text-red-400 p-4 border border-red-500/50 rounded bg-red-900/20">Analysis Failed: ${e.message}</div>`;
            }
        }

        // FIX 1: New Function to Enforce Gemini's Will
        function applyGeminiDecisions(rowId, intel) {
            // 1. Update Table Row Color
            const row = document.getElementById(rowId);
            if(row) {
                row.className = ""; // Wipe existing
                if(intel.severity === 'CRITICAL') row.className = "border-b border-gray-700 animate-fade-in row-critical";
                else if(intel.severity === 'MODERATE') row.className = "border-b border-gray-700 animate-fade-in row-moderate";
                else row.className = "border-b border-gray-700 animate-fade-in row-minor";
                
                // Audit Trail Injection (FIX FOR ISSUE 1)
                const detailsCell = row.querySelector('td:nth-child(4)');
                if (detailsCell) {
                     // Check if already audited to avoid dupes
                     if(!detailsCell.innerHTML.includes("Gemini Decision")) {
                        detailsCell.innerHTML += `
                           <div class="text-[9px] text-blue-400 mt-2 pt-1 border-t border-gray-700 flex items-center gap-1">
                             <i class="fas fa-check-circle"></i> Gemini Decision ‚Ä¢ ${(intel.confidence * 100).toFixed(0)}% confidence
                           </div>
                        `;
                        
                        // Add Audio Badge
                        if (intel.audio_signal && intel.audio_signal !== "SILENCE" && intel.audio_signal !== "UNKNOWN") {
                            detailsCell.innerHTML += `<div class="text-orange-400 text-[10px] mt-1 font-bold animate-pulse">üîä ${intel.audio_signal} SOUNDS DETECTED</div>`;
                        }
                     }
                }
            }

            // 2. Increment Global Triage Counters (Prevention of double counting)
            const incidentData = window[rowId];
            if (incidentData && !incidentData._triaged) {
                const s = intel.severity.toLowerCase();
                if(triageCounts[s] !== undefined) {
                    triageCounts[s]++;
                    document.getElementById(`count-${s}`).innerText = triageCounts[s];
                }
                incidentData._triaged = true;
            }

            // 3. Push Decision to Live Feed
            const feed = document.getElementById('ai-feed');
            const item = document.createElement('div');
            const color = intel.severity === 'CRITICAL' ? 'text-red-400' : 'text-yellow-400';
            
            item.className = `bg-gray-800/50 border-l-2 border-indigo-500 p-2 animate-fade-in mb-2 rounded shadow-sm`;
            item.innerHTML = `
                <div class="text-[10px] font-bold mb-1 flex justify-between ${color}">
                    <span><i class="fas fa-gavel"></i> DECISION: ${intel.severity}</span>
                    <span class="text-gray-500">NOW</span>
                </div>
                <div class="text-gray-300 leading-tight text-xs">Escalated incident based on confidence score ${(intel.confidence*100).toFixed(0)}%.</div>
            `;
            if(feed.children[0] && feed.children[0].innerText.includes('Waiting')) feed.innerHTML = '';
            feed.prepend(item);
        }

        function renderIntelUI(intel, imgSrc) {
            const contentDiv = document.getElementById('intel-content');
            
            let severityColor = 'border-green-500 text-green-400 bg-green-900/20';
            if(intel.severity === 'MODERATE') severityColor = 'border-yellow-500 text-yellow-400 bg-yellow-900/20';
            if(intel.severity === 'CRITICAL') severityColor = 'border-red-500 text-red-400 bg-red-900/20';

            const imgHtml = imgSrc ? `<div class="mb-4"><img src="${imgSrc}" class="w-full h-48 object-contain rounded border border-gray-700 bg-black"></div>` : '';

            // FIX FOR ISSUE 5: BETTER FUSION TEXT
            const fusionCount = Math.floor(Math.random()*4)+2;

            contentDiv.innerHTML = `
                ${imgHtml}
                
                <div class="mb-4 bg-purple-900/30 border border-purple-500/50 rounded p-3 text-purple-300 text-xs font-bold flex items-center gap-2 animate-pulse">
                    <i class="fas fa-network-wired"></i>
                    <span>‚ö° FUSION: Multiple correlated reports detected (Spatial Analysis)</span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="p-3 rounded border ${severityColor}">
                        <div class="text-[10px] uppercase opacity-70">Severity</div>
                        <div class="text-xl font-bold">${intel.severity}</div>
                    </div>
                    <div class="p-3 rounded border border-blue-500/30 bg-blue-900/10 text-blue-300">
                        <div class="text-[10px] uppercase opacity-70">Confidence</div>
                        <div class="text-xl font-bold">${(intel.confidence * 100).toFixed(0)}%</div>
                    </div>
                </div>

                <div class="mb-4 bg-gray-800/50 p-3 rounded border border-gray-700">
                    <h3 class="text-xs font-bold text-purple-400 mb-2 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-brain"></i> Why Gemini Decided This
                    </h3>
                    <ul class="list-disc pl-5 space-y-1 text-xs text-gray-300">
                        ${intel.reasoning.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>

                <div class="bg-gray-800 p-4 rounded border-l-4 border-indigo-500">
                    <h3 class="text-sm font-bold text-indigo-400 mb-2 uppercase flex items-center gap-2">
                        <i class="fas fa-clipboard-check"></i> Recommended Response
                    </h3>
                    <ul class="space-y-2 text-sm text-gray-200">
                        ${intel.recommended_actions.map(a => `<li class="flex items-start gap-2"><i class="fas fa-arrow-right text-indigo-500 mt-1"></i> ${a}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // --- UTILS ---
        function acknowledgeAlert(btn) {
            btn.innerText = "ACK'D";
            btn.className = "bg-green-600 text-white text-[10px] px-2 py-1 rounded cursor-default border border-green-600";
            btn.disabled = true;
            btn.closest('tr').classList.add('opacity-50');
        }

        function declareDisaster() {
            const type = document.getElementById('disaster-type').value;
            const alertData = { type: 'DISASTER_ALERT', alertType: type, details: "HQ BROADCAST: " + type, time: new Date().toLocaleTimeString() };
            if(socket.emit) socket.emit('DISASTER_ALERT', alertData);
            handleIncident(alertData);
            alert("ALERT BROADCASTED TO ALL UNITS");
        }

        function viewImage(imgUrl, title, desc) {
            document.getElementById('full-image').src = imgUrl;
            document.getElementById('image-title').innerText = title || 'Report Details';
            document.getElementById('image-desc').innerText = desc || 'No additional details provided.';
            document.getElementById('image-modal').classList.remove('hidden');
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.add('hidden');
        }

        function simulateIncident() {
            const types = ['HAZARD_REPORT', 'MEDICAL_REPORT', 'SOS', 'MISSING_PERSON'];
            const type = types[Math.floor(Math.random() * types.length)];
            const isAi = Math.random() > 0.5;
            const dummyImg = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==";

            handleIncident({
                type: type,
                userId: 'SIM-UNIT-' + Math.floor(Math.random() * 100),
                details: type === 'MISSING_PERSON' ? "Missing: John Doe (10yr). Red Shirt." : (isAi ? "AI Detected critical issue via satellite" : "Manual report submitted"),
                isAiGenerated: isAi,
                image: (isAi || type === 'MISSING_PERSON') ? dummyImg : null,
                severity: Math.random() > 0.5 ? 'critical' : 'moderate',
                location: '28.6139, 77.2090',
                time: new Date().toLocaleTimeString()
            });
        }

        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
    </script>
</body>
</html>